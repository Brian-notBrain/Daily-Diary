<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>ðŸ“– æˆ‘çš„æ¼«ç•«æ…¢ç”Ÿæ´»æ—¥è¨˜</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 2rem;
      background: #fdf6e3;
      position: relative;
    }
    h1 {
      display: inline-block;
    }
    #user-info {
      position: absolute;
      top: 2rem;
      right: 2rem;
      text-align: right;
    }
    input, textarea {
      display: block;
      margin: 1rem 0;
      width: 100%;
      padding: 0.5rem;
      font-size: 1rem;
    }
    button {
      padding: 0.5rem 1rem;
      background: #88c0d0;
      border: none;
      color: white;
      cursor: pointer;
      margin-top: 1rem;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .entry {
      background: white;
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <h1>ðŸ“– æˆ‘çš„æ¼«ç•«æ…¢ç”Ÿæ´»æ—¥è¨˜</h1>
  <div id="user-info">
    <span id="username"></span>
    <button id="logout" style="display: none;">ç™»å‡º</button>
    <button id="login">ä½¿ç”¨ Google ç™»å…¥</button>
  </div>

  <input type="text" id="title" placeholder="ä»Šå¤©çœ‹çš„æ¼«ç•« / æ›¸å">
  <textarea id="thoughts" placeholder="å¯«ä¸‹ä½ çš„ä¸€å¥æ„Ÿæƒ³..."></textarea>
  <input type="text" id="emoji" placeholder="ç”¨ä¸€å€‹ emoji è¡¨é”ä»Šå¤©çš„å¿ƒæƒ… ðŸ˜Š">
  <button id="addEntry" disabled>åŠ å…¥æ—¥è¨˜</button>

  <div id="entries"></div>

  <!-- Firebase æ¨¡çµ„å¯«æ³• -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
    import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-database.js";
    import {
      getAuth,
      signInWithPopup,
      GoogleAuthProvider,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDubkeIiVxXQ-fAUU5KTCuh15EnP0k-NiY",
      authDomain: "diary-web-7384b.firebaseapp.com",
      databaseURL: "https://diary-web-7384b-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "diary-web-7384b",
      storageBucket: "diary-web-7384b.appspot.com",
      messagingSenderId: "992846427066",
      appId: "1:992846427066:web:77e054330f232d44352383"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    const loginBtn = document.getElementById("login");
    const logoutBtn = document.getElementById("logout");
    const usernameSpan = document.getElementById("username");
    const addEntryBtn = document.getElementById("addEntry");
    const titleInput = document.getElementById("title");
    const thoughtsInput = document.getElementById("thoughts");
    const emojiInput = document.getElementById("emoji");
    const entriesDiv = document.getElementById("entries");

    let currentUser = null;

    loginBtn.addEventListener("click", () => {
      signInWithPopup(auth, provider).catch((error) => {
        console.error("ç™»å…¥å¤±æ•—", error);
      });
    });

    logoutBtn.addEventListener("click", () => {
      signOut(auth);
    });

    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
        usernameSpan.textContent = `${user.displayName}`;
        loginBtn.style.display = "none";
        logoutBtn.style.display = "inline-block";
        addEntryBtn.disabled = false;
        loadEntries(user.uid);
      } else {
        currentUser = null;
        usernameSpan.textContent = "";
        loginBtn.style.display = "inline-block";
        logoutBtn.style.display = "none";
        addEntryBtn.disabled = true;
        entriesDiv.innerHTML = "<p>è«‹å…ˆç™»å…¥ä»¥æŸ¥çœ‹ä½ çš„æ—¥è¨˜ã€‚</p>";
      }
    });

    addEntryBtn.addEventListener("click", () => {
      const title = titleInput.value.trim();
      const thoughts = thoughtsInput.value.trim();
      const emoji = emojiInput.value.trim();
      if (!title || !thoughts || !emoji || !currentUser) return;

      const entry = {
        title,
        thoughts,
        emoji,
        createdAt: Date.now()
      };

      const userRef = ref(db, `users/${currentUser.uid}/entries`);
      push(userRef, entry);

      titleInput.value = "";
      thoughtsInput.value = "";
      emojiInput.value = "";
    });

    function loadEntries(uid) {
      const userRef = ref(db, `users/${uid}/entries`);
      onValue(userRef, (snapshot) => {
        const data = snapshot.val();
        entriesDiv.innerHTML = "";
        const sorted = Object.entries(data || {}).sort((a, b) => b[1].createdAt - a[1].createdAt);
        sorted.forEach(([key, entry]) => {
          const entryDiv = document.createElement("div");
          entryDiv.className = "entry";
          entryDiv.innerHTML = `
            <h3>${entry.title}</h3>
            <p>${entry.thoughts}</p>
            <p>${entry.emoji}</p>
          `;
          entriesDiv.appendChild(entryDiv);
        });
      });
    }
  </script>
</body>
</html>
