<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ“– æˆ‘çš„æ¼«ç•«æ…¢ç”Ÿæ´»æ—¥è¨˜</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 2rem;
      background: #fdf6e3;
    }
    #auth-section {
      position: absolute;
      top: 1rem;
      right: 1rem;
    }
    input, textarea {
      display: block;
      margin: 0.5rem 0;
      width: 100%;
      padding: 0.5rem;
      font-size: 1rem;
    }
    button {
      padding: 0.5rem 1rem;
      background: #88c0d0;
      border: none;
      color: white;
      cursor: pointer;
      margin-top: 0.5rem;
    }
    .entry, .archive-entry {
      background: white;
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 8px;
    }
    #archive-controls {
      margin-top: 1rem;
    }
    #archive-section {
      margin-top: 3rem;
    }
    .toggle-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
  </style>
</head>
<body>
  <h1>ğŸ“– æˆ‘çš„æ¼«ç•«æ…¢ç”Ÿæ´»æ—¥è¨˜</h1>

  <div id="auth-section">
    <span id="user-name"></span>
    <button id="login-btn">Google ç™»å…¥</button>
    <button id="logout-btn" style="display:none;">ç™»å‡º</button>
  </div>

  <div id="diary-form" style="display: none;">
    <input type="text" id="title" placeholder="ä»Šå¤©çœ‹çš„æ¼«ç•« / æ›¸å" />
    <textarea id="thoughts" placeholder="å¯«ä¸‹ä½ çš„ä¸€å¥æ„Ÿæƒ³..."></textarea>
    <input type="text" id="emoji" placeholder="ç”¨ä¸€å€‹ emoji è¡¨é”ä»Šå¤©çš„å¿ƒæƒ… ğŸ˜Š" />
    <input type="date" id="date" />
    <div class="toggle-row">
      <label for="isPublic">æ˜¯å¦å…¬é–‹ï¼š</label>
      <input type="checkbox" id="isPublic" />
    </div>
    <button id="addEntry">åŠ å…¥æ—¥è¨˜</button>
  </div>

  <div id="archive-section">
    <h2>ğŸ“š éå¾€æ—¥è¨˜</h2>
    <div id="archive-entries"></div>
    <div id="archive-controls">
      <button id="prev-btn">â†</button>
      <button id="next-btn">â†’</button>
    </div>
  </div>

  <!-- Firebase Module -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
    import { getDatabase, ref, push, onValue, get, child } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-database.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDubkeIiVxXQ-fAUU5KTCuh15EnP0k-NiY",
      authDomain: "diary-web-7384b.firebaseapp.com",
      databaseURL: "https://diary-web-7384b-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "diary-web-7384b",
      storageBucket: "diary-web-7384b.appspot.com",
      messagingSenderId: "992846427066",
      appId: "1:992846427066:web:77e054330f232d44352383"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth();
    const provider = new GoogleAuthProvider();

    const loginBtn = document.getElementById("login-btn");
    const logoutBtn = document.getElementById("logout-btn");
    const userNameSpan = document.getElementById("user-name");
    const diaryForm = document.getElementById("diary-form");

    const titleInput = document.getElementById("title");
    const thoughtsInput = document.getElementById("thoughts");
    const emojiInput = document.getElementById("emoji");
    const dateInput = document.getElementById("date");
    const isPublicInput = document.getElementById("isPublic");
    const addEntryBtn = document.getElementById("addEntry");
    const archiveDiv = document.getElementById("archive-entries");
    const prevBtn = document.getElementById("prev-btn");
    const nextBtn = document.getElementById("next-btn");

    let currentUser = null;
    let allEntries = [];
    let currentPage = 0;
    const ENTRIES_PER_PAGE = 3;

    loginBtn.onclick = () => signInWithPopup(auth, provider);
    logoutBtn.onclick = () => signOut(auth);

    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      if (user) {
        userNameSpan.textContent = `ä½ å¥½ï¼Œ${user.displayName}`;
        loginBtn.style.display = "none";
        logoutBtn.style.display = "inline";
        diaryForm.style.display = "block";
      } else {
        userNameSpan.textContent = "";
        loginBtn.style.display = "inline";
        logoutBtn.style.display = "none";
        diaryForm.style.display = "none";
      }
      fetchEntries();
    });

    addEntryBtn.onclick = () => {
      const title = titleInput.value.trim();
      const thoughts = thoughtsInput.value.trim();
      const emoji = emojiInput.value.trim();
      const date = dateInput.value.trim();
      const isPublic = isPublicInput.checked;

      if (!title || !thoughts || !emoji || !date) {
        alert("è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½");
        return;
      }

      const entry = {
        title,
        thoughts,
        emoji,
        date,
        isPublic,
        uid: currentUser.uid,
        createdAt: Date.now()
      };

      push(ref(db, "diaryEntries"), entry);

      titleInput.value = "";
      thoughtsInput.value = "";
      emojiInput.value = "";
      dateInput.value = "";
      isPublicInput.checked = false;
    };

    function fetchEntries() {
      get(ref(db, "diaryEntries")).then((snapshot) => {
        const data = snapshot.val() || {};
        allEntries = Object.values(data).filter(entry => {
          return entry.isPublic || (currentUser && entry.uid === currentUser.uid);
        }).sort((a, b) => b.createdAt - a.createdAt);
        renderArchive();
      });
    }

    function renderArchive() {
      archiveDiv.innerHTML = "";
      const start = currentPage * ENTRIES_PER_PAGE;
      const pageEntries = allEntries.slice(start, start + ENTRIES_PER_PAGE);

      pageEntries.forEach(entry => {
        const div = document.createElement("div");
        div.className = "archive-entry";
        div.innerHTML = `
          <h3>${entry.title}</h3>
          <p>${entry.thoughts}</p>
          <p>${entry.emoji}</p>
          <p><strong>${entry.date}</strong></p>
        `;
        archiveDiv.appendChild(div);
      });

      prevBtn.disabled = currentPage === 0;
      nextBtn.disabled = start + ENTRIES_PER_PAGE >= allEntries.length;
    }

    prevBtn.onclick = () => {
      if (currentPage > 0) {
        currentPage--;
        renderArchive();
      }
    };

    nextBtn.onclick = () => {
      if ((currentPage + 1) * ENTRIES_PER_PAGE < allEntries.length) {
        currentPage++;
        renderArchive();
      }
    };

    // é è¨­æ—¥æœŸå¡«ä»Šå¤©
    dateInput.valueAsDate = new Date();
  </script>
</body>
</html>
